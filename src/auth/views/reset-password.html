<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Restablecer Contrase√±a - Router Manager</title>
<style>
* { margin:0; padding:0; box-sizing:border-box; }
body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background:linear-gradient(135deg,#667eea 0%,#764ba2 100%); min-height:100vh; display:flex; align-items:center; justify-content:center; padding:20px; }
.reset-container { background:white; border-radius:15px; padding:40px; box-shadow:0 20px 40px rgba(0,0,0,0.1); width:100%; max-width:450px; text-align:center; }
.logo { font-size:28px; font-weight:bold; color:#333; margin-bottom:10px; }
.subtitle { color:#666; margin-bottom:30px; font-size:14px; }
.form-group { margin-bottom:20px; text-align:left; }
label { display:block; margin-bottom:8px; color:#333; font-weight:500; font-size:14px; }
input[type="email"], input[type="password"] { width:100%; padding:15px; border:2px solid #e1e5e9; border-radius:8px; font-size:16px; transition:border-color 0.3s ease; background:#f8f9fa; }
input[type="email"]:focus, input[type="password"]:focus { outline:none; border-color:#667eea; background:white; }
input[type="email"]:disabled { background:#e9ecef; color:#6c757d; cursor:not-allowed; }
.password-strength { margin-top:8px; font-size:12px; }
.strength-weak { color:#dc3545; }
.strength-medium { color:#fd7e14; }
.strength-strong { color:#28a745; }
.btn { width:100%; padding:15px; background:linear-gradient(135deg,#667eea 0%,#764ba2 100%); color:white; border:none; border-radius:8px; font-size:16px; font-weight:600; cursor:pointer; transition:transform 0.2s ease, box-shadow 0.2s ease; margin-top:10px; }
.btn:hover { transform:translateY(-2px); box-shadow:0 10px 20px rgba(102,126,234,0.3); }
.btn:disabled { opacity:0.6; cursor:not-allowed; transform:none; }
.error { color:#dc3545; font-size:14px; margin-top:10px; padding:10px; background:#f8d7da; border-radius:5px; display:none; }
.success { color:#155724; font-size:14px; margin-top:10px; padding:10px; background:#d4edda; border-radius:5px; display:none; }
.loading { display:none; margin-top:10px; }
.spinner { border:3px solid #f3f3f3; border-top:3px solid #667eea; border-radius:50%; width:20px; height:20px; animation:spin 1s linear infinite; display:inline-block; margin-right:10px; }
.info { color:#0c5460; font-size:12px; margin-top:5px; padding:8px; background:#b8daff; border-radius:5px; }
@keyframes spin { 0%{transform:rotate(0deg);} 100%{transform:rotate(360deg);} }
</style>
</head>
<body>
<div class="reset-container">
  <div class="logo">üîê Router Manager</div>
  <div class="subtitle">Restablece tu contrase√±a</div>
  
  <form id="resetForm">
    <div class="form-group">
      <label for="email">Email:</label>
      <input type="email" id="email" name="email" required>
      <div class="info" id="emailInfo" style="display:none;"></div>
    </div>
    
    <div class="form-group">
      <label for="newPassword">Nueva Contrase√±a:</label>
      <input type="password" id="newPassword" name="newPassword" required>
      <div class="password-strength" id="passwordStrength"></div>
    </div>
    
    <div class="form-group">
      <label for="confirmPassword">Confirmar Contrase√±a:</label>
      <input type="password" id="confirmPassword" name="confirmPassword" required>
    </div>
    
    <button type="submit" class="btn" id="submitBtn">Cambiar Contrase√±a</button>
    
    <div class="loading" id="loading"><div class="spinner"></div>Cambiando contrase√±a...</div>
    <div class="error" id="errorMsg"></div>
    <div class="success" id="successMsg"></div>
  </form>
</div>

<script>
// üîπ Capturar par√°metros de la URL (del email de Firebase)
function getUrlParams() {
  const urlParams = new URLSearchParams(window.location.search);
  return {
    email: urlParams.get('email'),
    token: urlParams.get('oobCode') || urlParams.get('token'),
    mode: urlParams.get('mode')
  };
}

// üîπ Inicializar la p√°gina
window.addEventListener('DOMContentLoaded', function() {
  const params = getUrlParams();
  
  if (params.email) {
    document.getElementById('email').value = params.email;
    document.getElementById('email').disabled = true;
    document.getElementById('emailInfo').textContent = 'Email verificado desde el enlace';
    document.getElementById('emailInfo').style.display = 'block';
  }
  
  if (params.token) {
    console.log('Token detectado:', params.token.substring(0, 10) + '...');
  }
});

// üîπ Validaci√≥n de contrase√±a en tiempo real
document.getElementById('newPassword').addEventListener('input', function() {
  const password = this.value;
  const strengthEl = document.getElementById('passwordStrength');
  if(password.length===0){strengthEl.textContent='';return;}
  let strength=0;
  if(password.length>=8) strength++;
  if(password.match(/[a-z]/)) strength++;
  if(password.match(/[A-Z]/)) strength++;
  if(password.match(/[0-9]/)) strength++;
  if(password.match(/[^a-zA-Z0-9]/)) strength++;
  if(strength<=2){strengthEl.textContent='Contrase√±a d√©bil'; strengthEl.className='password-strength strength-weak';}
  else if(strength<=4){strengthEl.textContent='Contrase√±a media'; strengthEl.className='password-strength strength-medium';}
  else{strengthEl.textContent='Contrase√±a fuerte'; strengthEl.className='password-strength strength-strong';}
});

// üîπ Validaci√≥n de confirmaci√≥n de contrase√±a
document.getElementById('confirmPassword').addEventListener('input', function() {
  const password = document.getElementById('newPassword').value;
  const confirm = this.value;
  this.style.borderColor = (confirm && password!==confirm)?'#dc3545':'#28a745';
});

// üîπ Manejar el env√≠o del formulario
document.getElementById('resetForm').addEventListener('submit', async function(e){
  e.preventDefault();
  const formData = new FormData(this);
  const password = formData.get('newPassword');
  const confirmPassword = formData.get('confirmPassword');
  const emailValue = formData.get('email');
  const params = getUrlParams();

  // Validaciones
  if(password!==confirmPassword){ 
    showError('Las contrase√±as no coinciden'); 
    return; 
  }
  if(password.length<6){ 
    showError('La contrase√±a debe tener al menos 6 caracteres'); 
    return; 
  }
  if(!emailValue){ 
    showError('Debes ingresar tu email'); 
    return; 
  }

  showLoading(true);

  try {
    // Si NO viene del email (sin token), hacer flujo manual
    if (!params.token) {
      console.log('üîÑ Flujo manual (sin token del email)');
      
      // 1Ô∏è‚É£ Verificar email manualmente
      let verifyResp = await fetch('http://localhost:3000/auth/email/verify-manual',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({email:emailValue})
      });
      let verifyResult = await verifyResp.json();
      if(!verifyResp.ok){ 
        showError(verifyResult.message||'El correo no existe'); 
        showLoading(false); 
        return; 
      }
    } else {
      console.log('üîó Flujo desde email (con token)');
    }

    // 2Ô∏è‚É£ Cambiar la contrase√±a
    const resetPayload = {
      email: emailValue,
      newPassword: password
    };
    
    // Si hay token, incluirlo
    if (params.token) {
      resetPayload.token = params.token;
    }

    let resetResp = await fetch('http://localhost:3000/auth/password/reset',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify(resetPayload)
    });
    let resetResult = await resetResp.json();

    if(resetResp.ok){ 
      showSuccess('¬°Contrase√±a cambiada exitosamente! Redirigiendo al login...');
      this.style.display='none';
      
      // Redirigir al login despu√©s de 3 segundos
      setTimeout(() => {
        window.location.href = '/login.html'; // Ajusta la ruta seg√∫n tu estructura
      }, 3000);
    }
    else{ 
      showError(resetResult.message||'Error al cambiar contrase√±a'); 
    }
    
  } catch(err){
    console.error('Error:', err);
    showError('Error de conexi√≥n. Intenta nuevamente.');
  } finally { 
    showLoading(false); 
  }
});

// üîπ Funciones de UI
function showError(msg){ 
  const e=document.getElementById('errorMsg'); 
  const s=document.getElementById('successMsg'); 
  e.textContent=msg;
  e.style.display='block'; 
  s.style.display='none'; 
}

function showSuccess(msg){ 
  const e=document.getElementById('errorMsg'); 
  const s=document.getElementById('successMsg'); 
  s.textContent=msg;
  s.style.display='block'; 
  e.style.display='none'; 
}

function showLoading(show){ 
  const l=document.getElementById('loading'); 
  const b=document.getElementById('submitBtn'); 
  l.style.display=show?'block':'none'; 
  b.style.display=show?'none':'block'; 
}
</script>
</body>
</html>